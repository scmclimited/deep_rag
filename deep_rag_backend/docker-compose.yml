services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: deep_rag_api
    env_file:
      - ../../.env
    environment:
      # Database connection - use db service if in same network, or localhost for standalone
      # set DB_HOST to the DB service name on that network (e.g., deep_rag_pgvector or db).
      DB_HOST: ${DB_HOST:-localhost}
      # Prefer explicit DB host via .env; if this compose runs with your DB compose,
      DB_PORT: ${DB_PORT:-5432}
      DB_USER: ${DB_USER}
      DB_PASS: ${DB_PASS}
      DB_NAME: ${DB_NAME}
      # Optional: Set RUN_TESTS_ON_STARTUP=true to run database schema tests on startup
      # RUN_TESTS_ON_STARTUP: ${RUN_TESTS_ON_STARTUP:-false}
    ports:
      - "8000:8000"
    volumes:
      - ./inference/graph/logs:/app/inference/graph/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # === GPU enablement (Compose v2) ===
    # This works on most local setups with the NVIDIA Container Toolkit installed.
    gpus: "all"
    # If your environment only honors Swarm-style device reservations, also add:
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]
              count: all
    # Optional: Connect to external network if database is in another compose file
    # networks:
    #   - deep_rag_network
    # Optional: Use external network for database connection
    # networks:
    #   deep_rag_network:
    #     external: true
